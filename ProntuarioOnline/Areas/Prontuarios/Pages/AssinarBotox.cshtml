@page "{id}"
@model ProntuarioOnline.Areas.Prontuarios.Pages.AssinarBotoxModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@Html.AntiForgeryToken()

@{
  Layout = "_Layout";
}

<div class="container-fluid mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Dados do Cadastro</h4>
    </div>
    <div class="card-body" style="max-height:80vh; overflow-y:auto;">
      <h2 class="text-center mb-3">Termo de Consentimento</h2>
      <h4 class="text-center mb-4">Toxina Botulínica</h4>

      <p class="fs-5 text-justify">
        Declaro estar ciente e concordo em realizar o procedimento de aplicação de toxina butolínica conforme orientação e
        esclarecimentos prestados pelo(a) profissional responsável.
      </p>
      <p class="fs-5 text-justify">
        Declaro, também, que recebi informações adequadas sobre a aplicação da toxína butolínica e suas possíveis complicações,
        riscos e benefícios.
      </p>
      <p class="fs-5 text-justify">
        <strong>
          Declaro que fui informado de que a fraqueza muscular começa após 24 horas da aplicação, clinicamente sendo observada
          entre 2 a 7 dias da aplicação, completando o efeito máximo em 15 dias.
          Estou ciente de que a duração do efeito é de 2 a 6 meses, com média de 4 meses.
        </strong>
      </p>
      <p class="fs-5 text-justify">
        Entendo que a toxina butolínica é um medicmante injetável usado para tratar determinadas condições médicas, tais como
        rugas faciais, disturbios neurológicos e hiperidrose, entre outras.
      </p>

      <h4 class="text-center mb-4">Ao assinar esse termo reconheço e concordo com os seguintes pontos:</h4>

      <p class="fs-5 text-justify">
        <strong>Natureza do procedimento:</strong> Compreendo que a aplicação de toxina butolínica será feita através de injeções nas áreas
        específicadas acordadas com o (a) profissional responsável, com o objetivo de melhorar ou tratar a condição mencionada.
      </p>

      <p class="fs-5 text-justify">
        <strong>Benefícios e resultado esperados:</strong> Fui informado de que os benefícios da aplicação de toxina butolínica podem incluir a
        redução das rugas e linhas de expressão, melhora dos sintomas de disturbios neurológicos, redução da sudorese excessiva
        entre outros tratamentos discutidos com o(a) profissional. No entanto, entende que os resultados podem varia de pessoa
        para pessoa, e não há garantia de resultados completos ou permanentes.
      </p>

      <p class="fs-5 text-justify">
        <strong>Reconheço que existem datores que interferem na duração da toxina, como:</strong> A prática de atividade fisíca, ser uma
        pessoa muito expressiva, uso de corticóides e antibióticos, tabagismo e exposição solar.
      </p>

      <p class="fs-5 text-justify">
        <strong>Esclarecimentos:</strong> Recebi a oportunidade de fazer perguntas sobre o procedimento, seus riscos e benefícios e todas as
        minhas dúvidas foram respondidas satisfatóriamente.
      </p>

      <h4 class="text-center mb-4">Riscos e complicações</h4>

      <p class="fs-5 text-justify">
        Fui devidamente informado sobre os riscos associados à aplicação de toxina butolínica, que pode incluir, mas não se limitam a:
      </p>

      <p class="fs-5 text-justify">
        ·Reações alérgicas, como coceira, vermelhidão, inchaço ou erupções cuâneas;
      </p>

      <p class="fs-5 text-justify">
        ·Hematomas, dor ou desconforto no local da injeção;
      </p>

      <p class="fs-5 text-justify">
        ·Fraqueza muscular temporária na área tratada;
      </p>

      <p class="fs-5 text-justify">
        ·Assimetria facial ou alterações na expressão facial;
      </p>

      <p class="fs-5 text-justify">
        ·Infecção no local da injeção;
      </p>

      <p class="fs-5 text-justify">
        ·Outras complicações possíveis que me foram explicadas pelo(a) profissional;
      </p>

      <!-- Observações -->
      <div class="mb-3">
        <label for="observacoes" class="form-label">Observações</label>
        <textarea id="observacoes" class="form-control" rows="4"></textarea>
      </div>

      <!-- Switch AceitaDivulgacao -->
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="aceitaDivulgacao" />
        <label class="form-check-label" for="aceitaDivulgacao">
          Autorizo a divulgação de imagens para fins científicos/educacionais
        </label>
      </div>

      <div class="mt-4 text-center">
        <button type="button" class="btn btn-primary" id="start">Assinar Documento</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal fullscreen para assinatura -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assine o documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <canvas id="signature-pad" class="border w-100" style="height:400px;"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="clear">Limpar</button>
        <button type="button" class="btn btn-success" id="save">Salvar Assinatura</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast para feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toastMsg" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">Assinatura salva com sucesso!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script>
    var signaturePad = null;

    // Abre modal e inicializa assinatura
    document.getElementById('start').addEventListener('click', function () {
        var modalEl = document.getElementById('signatureModal');
        var modal = new bootstrap.Modal(modalEl);
        modal.show();

        modalEl.addEventListener('shown.bs.modal', function () {
            var canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas);

            // Ajusta o canvas para telas de alta densidade
            var ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }, { once: true });
    });

    // Limpar assinatura
    document.getElementById('clear').addEventListener('click', function () {
        if (signaturePad) signaturePad.clear();
    });

    // Converter base64 em array de bytes
    function base64ToBytes(base64) {
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return Array.from(bytes);
    }

    function getCsrfToken() {
        const el = document.querySelector('input[name="__RequestVerificationToken"]');
        return el ? el.value : null;
    }

    document.getElementById('save').addEventListener('click', function () {
        if (signaturePad && !signaturePad.isEmpty()) {
            var data = signaturePad.toDataURL('image/png');
            var base64 = data.replace(/^data:image\/(png|jpeg);base64,/, "");
            var byteArray = base64ToBytes(base64);

            const token = getCsrfToken();
            if (!token) {
                console.error("Token antiforgery não encontrado na página.");
                alert("Erro de segurança: token não encontrado.");
                return;
            }

            var aceitaDivulgacao = document.getElementById('aceitaDivulgacao').checked;
            var observacoes = document.getElementById('observacoes').value;


            fetch(`/Prontuarios/AssinarBotox/@Model.BotoxId?handler=SalvarAssinatura`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    Id: '@Model.BotoxId',
                    PdfAssinado: base64,
                    AceitaDivulgacao: aceitaDivulgacao,
                    Observacoes: observacoes
                })
            }).then(r => {
                if (r.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('signatureModal')).hide();
                    new bootstrap.Toast(document.getElementById('toastMsg')).show();
                    setTimeout(() => window.location.href = '/Prontuarios/PtBotox', 2000);
                } else {
                    r.text().then(t => console.error("Erro no backend:", t));
                }
            });
        } else {
            alert("Por favor, faça sua assinatura antes de salvar.");
        }
    });
  </script>
}