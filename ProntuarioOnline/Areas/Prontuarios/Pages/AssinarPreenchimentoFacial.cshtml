@page "{id}"
@model ProntuarioOnline.Areas.Prontuarios.Pages.AssinarPreenchimentoFacialModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@Html.AntiForgeryToken()

@{
  Layout = "_Layout";
}

<div class="container-fluid mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Dados do Cadastro</h4>
    </div>
    <div class="card-body" style="max-height:80vh; overflow-y:auto;">
      <h2 class="text-center mb-3">TERMO DE CONSENTIMENTO LIVRE E ESCLARECIDO - PREENCHEDORES</h2>

      <p class="fs-5 text-justify">
        Eu, @Model.Pessoa.Nome, portador do CPF @Model.Pessoa.Cpf, em pleno gozo de minhas faculdade mentais, livre e voluntariamente, aceito o tratamento com preenchedores
        faciais a ser realizado pela profissional habilitada para tal procedimento.
      </p>
      <p class="fs-5 text-justify">
        Declaro que recebi esclarecimentos quanto ao uso de preenchedores e etou cinete de que a mesma tem ação temporária e que cada pessoa apresenta uma resposta individual
        ao efeito do produto.
      </p>
      <p class="fs-5 text-justify">
        Declaro que estou ciente dos transtornos possíveis tais como: reação alérgica, hipoestesia transitória (estimulos táteis abaixo do normal),
        dor e edema no local da aplicação, eritema (vermelhidão na pele), hematomas, entorpecimento temporário, (fraqueza), náusea, dor de cabeça,
        extensão no local, paralisação indesejada de músculos adjacentes, xerostomia (secura excessiva da boca e alteração da voz), o que em sua maioria são
        transitórios e reversíveis.
      </p>
      <p class="fs-5 text-justify">
        É de meu conhecimento também que posso não fazer uso de preenchedores e optar por outro tipo de tratamento, como fui orientado(a) pela profissional.
      </p>
      <p class="fs-5 text-justify">
        Declaro que recebi explicações verbais sobre a natureza e propósitos do procedimento, assim como benefícios, riscos, alternativas e meios de tratamento.
        Estou ciente de que, para obter o melhor resultado, devo ficar sem abaixar a cabeça e sem relizar qualquer esforço fisíco durante quatro horas, assim como evitar
        apoiar as mãos sobre o rosto ou coçar as regiões que passaram por aplicações, pelo mesmo período de tempo e ainda, evitar atividades que possam provocar
        aquecimento (aplicar calor na face, consumo de álcool, exercício físico por 24h e exposição ao sol).
      </p>
      <p class="fs-5 text-justify">
        Declaro que respondi à anamnese (exame clínico e questionamentos de saúde), e não apresento alergia a ovo 9albumina), problemas de miasteria grave 9esclerose múltipla),
        acne, depressão, dismorfafobia, bem como nenhuma enfermidade descompensatória ou descompensada.
      </p>
      <p class="fs-5 text-justify">
        Declaro que entendi e estou safisfeito(a), com todas as explicações e esclarecimentos fornecidos pela profissional sobre o procedimento mencionado e que posso
        desiste a qualquer momento antes do inicio do procedimento.
      </p>
      <p class="fs-5 text-justify">
        É de meu conhecimento que a prática das ciências médicas não é uma ciência exata e reconheço que o prognóstico é apenas de ordem estatística não significando
        necessariamente o resultado.
      </p>
      

      <!-- Observações -->
      <div class="mb-3">
        <label for="observacoes" class="form-label">Assim sendo, reafirmo o meu consentimento para que seja realizado o procedimento:</label>
        <textarea id="observacoes" class="form-control" rows="4"></textarea>
      </div>
      <p class="fs-5 text-justify">
        E afirmo que a profissional colocou-se à minha disposição para esclarecer dúvidas ou ampliar informações caso eu demonstre interesse.
      </p>

      <div class="mt-4 text-center">
        <button type="button" class="btn btn-primary" id="start">Assinar Documento</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal fullscreen para assinatura -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assine o documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <canvas id="signature-pad" class="border w-100" style="height:400px;"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="clear">Limpar</button>
        <button type="button" class="btn btn-success" id="save">Salvar Assinatura</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast para feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toastMsg" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">Assinatura salva com sucesso!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script>
    var signaturePad = null;

    // Abre modal e inicializa assinatura
    document.getElementById('start').addEventListener('click', function () {
        var modalEl = document.getElementById('signatureModal');
        var modal = new bootstrap.Modal(modalEl);
        modal.show();

        modalEl.addEventListener('shown.bs.modal', function () {
            var canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas);

            // Ajusta o canvas para telas de alta densidade
            var ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }, { once: true });
    });

    // Limpar assinatura
    document.getElementById('clear').addEventListener('click', function () {
        if (signaturePad) signaturePad.clear();
    });

    // Converter base64 em array de bytes
    function base64ToBytes(base64) {
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return Array.from(bytes);
    }

    function getCsrfToken() {
        const el = document.querySelector('input[name="__RequestVerificationToken"]');
        return el ? el.value : null;
    }

    document.getElementById('save').addEventListener('click', function () {
        if (signaturePad && !signaturePad.isEmpty()) {
            var data = signaturePad.toDataURL('image/png');
            var base64 = data.replace(/^data:image\/(png|jpeg);base64,/, "");
            var byteArray = base64ToBytes(base64);

            const token = getCsrfToken();
            if (!token) {
                console.error("Token antiforgery não encontrado na página.");
                alert("Erro de segurança: token não encontrado.");
                return;
            }

            var observacoes = document.getElementById('observacoes').value;


            fetch(`/Prontuarios/AssinarPreenchimentoFacial/@Model.PreenchimentoFacialId?handler=SalvarAssinatura`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    Id: '@Model.PreenchimentoFacialId',
                    PdfAssinado: base64,
                    Observacoes: observacoes
                })
            }).then(r => {
                if (r.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('signatureModal')).hide();
                    new bootstrap.Toast(document.getElementById('toastMsg')).show();
                    setTimeout(() => window.location.href = '/Prontuarios/PtPreenchimentosFaciais', 2000);
                } else {
                    r.text().then(t => console.error("Erro no backend:", t));
                }
            });
        } else {
            alert("Por favor, faça sua assinatura antes de salvar.");
        }
    });
  </script>
}